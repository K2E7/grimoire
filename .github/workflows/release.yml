name: Release VSIX

on:
  push:
    branches:
      - "**"
    tags:
      - "v*.*.*"
  workflow_dispatch: {}

permissions:
  contents: write

concurrency:
  group: release-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Resolve workflow mode
        id: mode
        run: |
          set -euo pipefail

          PKG_VERSION="$(node -p "require('./package.json').version")"
          SHORT_SHA="${GITHUB_SHA::7}"
          EVENT_NAME="${GITHUB_EVENT_NAME}"
          REF_TYPE="${GITHUB_REF_TYPE}"
          REF_NAME="${GITHUB_REF_NAME}"

          RELEASE_MODE=""
          SHOULD_RELEASE="false"
          RELEASE_TAG=""
          RELEASE_TITLE=""
          IS_PRERELEASE="false"
          IS_ROLLING="false"
          BRANCH_SLUG=""

          if [[ "$REF_TYPE" == "tag" && "$REF_NAME" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            RELEASE_MODE="semver_tag_release"
            SHOULD_RELEASE="true"
            RELEASE_TAG="$REF_NAME"
            RELEASE_TITLE="Release $REF_NAME"
          elif [[ "$REF_TYPE" == "branch" && "$REF_NAME" == "main" ]]; then
            RELEASE_MODE="main_bump"
            RELEASE_TITLE="Main version bump @ $SHORT_SHA"
          else
            RELEASE_MODE="branch_snapshot"
            SHOULD_RELEASE="true"
            BRANCH_SLUG="$(
              echo "$REF_NAME" \
                | tr '[:upper:]' '[:lower:]' \
                | sed -E 's|[ /_]+|-|g; s|[^a-z0-9.-]+|-|g; s|-+|-|g; s|^-+||; s|-+$||'
            )"
            if [[ -z "$BRANCH_SLUG" ]]; then
              BRANCH_SLUG="snapshot"
            fi
            RELEASE_TAG="snapshot-$BRANCH_SLUG"
            RELEASE_TITLE="Snapshot $REF_NAME @ $SHORT_SHA"
            IS_PRERELEASE="true"
            IS_ROLLING="true"
          fi

          echo "event_name=$EVENT_NAME"
          echo "release_mode=$RELEASE_MODE"
          echo "should_release=$SHOULD_RELEASE"
          echo "release_tag=$RELEASE_TAG"
          echo "release_title=$RELEASE_TITLE"
          echo "pkg_version=$PKG_VERSION"
          echo "branch_slug=$BRANCH_SLUG"
          echo "is_prerelease=$IS_PRERELEASE"
          echo "is_rolling=$IS_ROLLING"

          {
            echo "release_mode=$RELEASE_MODE"
            echo "should_release=$SHOULD_RELEASE"
            echo "release_tag=$RELEASE_TAG"
            echo "release_title=$RELEASE_TITLE"
            echo "is_prerelease=$IS_PRERELEASE"
            echo "is_rolling=$IS_ROLLING"
            echo "pkg_version=$PKG_VERSION"
            echo "branch_slug=$BRANCH_SLUG"
          } >> "$GITHUB_OUTPUT"

      - name: Bump package version and push semver tag on main
        if: github.event_name == 'push' && steps.mode.outputs.release_mode == 'main_bump'
        env:
          ACTOR: ${{ github.actor }}
          HEAD_COMMIT_MESSAGE: ${{ github.event.head_commit.message }}
        run: |
          set -euo pipefail

          if [[ "$ACTOR" == "github-actions[bot]" && "$HEAD_COMMIT_MESSAGE" == chore\(release\):\ bump\ version\ to\ v* ]]; then
            echo "Skipping main bump on bot-generated release commit: $HEAD_COMMIT_MESSAGE"
            exit 0
          fi

          PKG_VERSION="$(node -p "require('./package.json').version")"
          PKG_BASE="${PKG_VERSION%%-*}"

          IFS='.' read -r PKG_MAJOR PKG_MINOR PKG_PATCH <<< "$PKG_BASE"
          if [[ -z "${PKG_MAJOR:-}" || -z "${PKG_MINOR:-}" || -z "${PKG_PATCH:-}" ]]; then
            echo "::error::package.json version must be semver (X.Y.Z). Found: $PKG_VERSION"
            exit 1
          fi

          git fetch --tags origin

          LATEST_TAG="$(
            git ls-remote --tags --refs origin "v*.*.*" \
              | awk '{print $2}' \
              | sed 's|refs/tags/||' \
              | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' \
              | sort -V \
              | tail -n 1 || true
          )"

          if [[ -z "$LATEST_TAG" ]]; then
            NEXT_VERSION="$PKG_BASE"
            echo "No prior semver tag found. Using package.json version: $NEXT_VERSION"
          else
            TAG_VERSION="${LATEST_TAG#v}"
            IFS='.' read -r TAG_MAJOR TAG_MINOR TAG_PATCH <<< "$TAG_VERSION"

            echo "Latest semver tag: $LATEST_TAG"
            echo "package.json version: $PKG_VERSION"

            if [[ "$PKG_MAJOR" == "$TAG_MAJOR" && "$PKG_MINOR" == "$TAG_MINOR" ]]; then
              if (( PKG_PATCH > TAG_PATCH )); then
                NEXT_PATCH="$((PKG_PATCH + 1))"
              else
                NEXT_PATCH="$((TAG_PATCH + 1))"
              fi
              NEXT_VERSION="${PKG_MAJOR}.${PKG_MINOR}.${NEXT_PATCH}"
            else
              NEXT_VERSION="$PKG_BASE"
            fi
          fi

          NEXT_TAG="v$NEXT_VERSION"
          echo "Selected NEXT_VERSION=$NEXT_VERSION"
          echo "Selected NEXT_TAG=$NEXT_TAG"

          if git ls-remote --exit-code --tags origin "refs/tags/$NEXT_TAG" >/dev/null 2>&1; then
            echo "::error::Tag collision detected: $NEXT_TAG already exists on origin."
            exit 1
          fi

          node -e "const fs=require('fs');const p=JSON.parse(fs.readFileSync('package.json','utf8'));p.version='$NEXT_VERSION';fs.writeFileSync('package.json', JSON.stringify(p,null,4)+'\n');"

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git checkout -B main "$GITHUB_SHA"

          git add package.json
          git commit --allow-empty -m "chore(release): bump version to $NEXT_TAG"
          git tag -a "$NEXT_TAG" -m "Release $NEXT_TAG"

          NEW_COMMIT="$(git rev-parse --short HEAD)"
          echo "Pushing bump commit $NEW_COMMIT to main and tag $NEXT_TAG"
          git push origin HEAD:main
          git push origin "$NEXT_TAG"

      - name: Validate semver tag major/minor vs package.json
        if: steps.mode.outputs.release_mode == 'semver_tag_release'
        run: |
          set -euo pipefail

          TAG_VERSION="${GITHUB_REF_NAME#v}"
          PKG_VERSION="${{ steps.mode.outputs.pkg_version }}"
          PKG_BASE="${PKG_VERSION%%-*}"

          IFS='.' read -r TAG_MAJOR TAG_MINOR _ <<< "$TAG_VERSION"
          IFS='.' read -r PKG_MAJOR PKG_MINOR _ <<< "$PKG_BASE"

          echo "Tag version: $TAG_VERSION"
          echo "Package version: $PKG_VERSION"
          echo "Comparing major.minor => ${TAG_MAJOR}.${TAG_MINOR} vs ${PKG_MAJOR}.${PKG_MINOR}"

          if [[ "$TAG_MAJOR" != "$PKG_MAJOR" || "$TAG_MINOR" != "$PKG_MINOR" ]]; then
            echo "::error::Version mismatch. Tag major/minor (${TAG_MAJOR}.${TAG_MINOR}) does not match package.json (${PKG_MAJOR}.${PKG_MINOR})"
            exit 1
          fi

      - name: Install vsce
        if: steps.mode.outputs.should_release == 'true'
        run: npm install -g @vscode/vsce

      - name: Package VSIX
        if: steps.mode.outputs.should_release == 'true'
        id: package
        run: |
          set -euo pipefail
          vsce package
          VSIX_FILE="$(ls -1 *.vsix | head -n 1)"
          if [[ -z "$VSIX_FILE" ]]; then
            echo "::error::No VSIX file produced by vsce package."
            exit 1
          fi
          echo "vsix_file=$VSIX_FILE" >> "$GITHUB_OUTPUT"
          ls -la "$VSIX_FILE"

      - name: Build release notes
        if: steps.mode.outputs.should_release == 'true'
        run: |
          set -euo pipefail
          {
            echo "Branch/Ref: ${GITHUB_REF_NAME}"
            echo "Commit: ${GITHUB_SHA}"
            echo "Package version: ${{ steps.mode.outputs.pkg_version }}"
            echo "Workflow run: https://github.com/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"
          } > release-notes.txt

      - name: Create/Update GitHub Release and upload VSIX
        if: steps.mode.outputs.should_release == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail

          TAG="${{ steps.mode.outputs.release_tag }}"
          TITLE="${{ steps.mode.outputs.release_title }}"
          IS_PRERELEASE="${{ steps.mode.outputs.is_prerelease }}"
          IS_ROLLING="${{ steps.mode.outputs.is_rolling }}"
          VSIX_FILE="${{ steps.package.outputs.vsix_file }}"
          NOTES_FILE="release-notes.txt"

          echo "Mode: ${{ steps.mode.outputs.release_mode }}"
          echo "Tag: $TAG"
          echo "Title: $TITLE"
          echo "Prerelease: $IS_PRERELEASE"
          echo "Rolling: $IS_ROLLING"

          if gh release view "$TAG" >/dev/null 2>&1; then
            echo "Release $TAG exists; updating metadata and replacing VSIX asset."
            if [[ "$IS_ROLLING" == "true" ]]; then
              gh release edit "$TAG" --title "$TITLE" --notes-file "$NOTES_FILE" --target "$GITHUB_SHA"
            else
              gh release edit "$TAG" --title "$TITLE" --notes-file "$NOTES_FILE"
            fi
            gh release upload "$TAG" "$VSIX_FILE" --clobber
          else
            CREATE_ARGS=("$TAG" "$VSIX_FILE" --title "$TITLE" --notes-file "$NOTES_FILE" --target "$GITHUB_SHA")
            if [[ "$IS_PRERELEASE" == "true" ]]; then
              CREATE_ARGS+=(--prerelease)
            fi
            gh release create "${CREATE_ARGS[@]}"
          fi
